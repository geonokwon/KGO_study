#  로드밸런서 구성 
- 클라이언트 요청을 직접 받고, 로드 밸런서가 관리하는 서버들에게 요청을 골고루 전달해주는 역할
- ELB(Elastic Load Balancer)에는 ALB, NLB, CLB 세 종류가 있음

ALB(Application Load Balancer)
- HTTP 및 HTTPS 에 가장 적합한 로드 밸런서이다.
- OSI 모델의 애플리케이션 계층(구체적인 통신을 제공하는 계층)에서 동작
- 현실 세계라면 애플리케이션 계층을 Layer 7 Switch(L7)로 구현
- 요청되는 명령어의 내용을 보고 판단하기 때문에 URL 디렉터리 단위로 분배하는 것이 가능
- 인스턴스와 로드밸런서 사이의 통신은 암호화가 가능하다는 특징도 있음.
- 지원 프로토콜 : HTTP, HTTPS

NLB(Network Load Balancer)
- OSI 모델의 전송 계층(전송된 데이터의 제어를 담당하는 계층)에서 동작
- 현실 세계라면 전송 계층에서 사용되는 Layer 4 Switch(L4)로 구현(TCP, UDP) 
- 지원 프로토콜 : TCP, SSL/TCL

CLB(Classic Load Balancer)
- 오래된 유형의 로드밸런서
- 지원하는 프로토콜이 많다는 장점이 있지만 이제 사용하지 않음.
- 지원 프로토콜 : TCP, SSL/TCL, HTTP, HTTPS

▪ ELB 요금
 - ALB와 NLB의 요금은 시간당 사용 요금과 LCU(로드 밸런서 용량 단위) 요금의 합계로 계산한다.
 - ALB 단가는 1시간당 0.0225 US달러 정도이고 LCU 요금은 1시간당 0.005 US달러 정도이다.
 - 요금 = ① 사용 요금 + ② LCU 요금
 - ① 사용 요금(사용단가 × 시간)
   => 사용 요금은 ELB의 종류별로 단가가 결정되며 여기에 시간을 곱한 금액이다.
   ② LCU 요금(LCU 사용량 × LCU 단가 × 시간)
   => LCU 요금은 측정 항목 4가지에 대해서 LCU 사용량이 ‘어떤 LCU 항목’에 해당하는지 환산하고 가장 큰 항목만 과금 대상으로 한다. 마찬가지로 LCU 사용량과 단가에 시간을 곱해서 산출한다.
 - LCU의 4가지 항목
   1) 새 연결 수(1LCU = 초당 25개의 새로운 연결)
      => 초당 새로운 확정 연결 수이다. 쉽게 말하면 PC나 스마트폰, 서버 등이 새로운 접속 수이다.
   2) 활성 연결 수(1LCU = 분당 3,000개의 활성 연결)
      => 분당 활성 연결 수이다. 즉, 현재 연결되어 있는 접속 수이다.
   3) 처리된 바이트(1LCU = 시간당 1GB)
      => 로드 밸런서에 따라서 처리된 HTTP(S) 요청과 응답의 바이트 수이다. Lambda 함수가 대상인 경우 1LCU = 시간당 0.4GB로 환산한다.
   4) 규칙 평가(1LCU = 초당 1,000 개의 규칙 평가)
      => 로드 밸런서에 의해 처리된 규칙 수와 요청 속도(1초간 송신된 요청 수)의 곱이다. 최초에 처리되는 규칙 10개는 무료이다.

#  로드밸런서 구성 실습 

1. EC2 대시보드 -> 왼쪽 메뉴 중 로드밸런싱 -> 로드밸런서 선택

2. 로드밸런서 생성 버튼 클릭

3. Application Load Balancer 아래의 '생성' 버튼 클릭

4. Application Load Balancer 생성 창
- 로드 밸런서 이름 : exercise-lb
- 체계 : 인터넷 경계(기본값)
- IP 주소 유형 : IPv4(기본값)

네트워크 매핑
- 가용영역 : ap-northeast-2a, ap-northeast-2c 체크

보안 그룹
- web 추가
- ELB(로드 밸런서)는 ssh 접속이 되지 않음.
=> ssh는 추가 불필요

리스너 및 라우팅
- 기본적으로 Protocol : HTTP, port : 80이 설정되어 있음
- 대상그룹(타겟그룹)이 설정되어 있지 않음
=> 대상그룹 : 로드밸런서가 클라이언트로부터 받은 요청을 전달할 대상 그룹
=> 대상 그룹 생성을 누르면 새 창이 생성

---

대상 그룹 생성
1단계(그룹 세부 정보 지정)
기본 구성
- 대상 유형 선택 : 인스턴스(기본값)
- 대상 그룹 이름 : exercise-target-group
- 프로토콜 : HTTP, Port : 80(기본값)
- IP 주소 유형 : IPv4(기본값)
- VPC : 기본값
- 프로토콜 버전 : HTTP1

상태 검사(Health Checks)
- 상태 검사 프로토콜 : HTTP
- 상태 검사 경로 : / => /health 로 변경

설정이 끝나면 '다음' 클릭

2단계(대상 등록)
- 인스턴스를 직접 선택해서 추가할 수 있음
- Auto Scaling 으로 인해 자동으로 만들어질 인스턴스를 타겟 그룹으로 할 것이므로
  선택하지 않고 '대상 그룹 생성' 클릭

대상 그룹이 만들어졌다면 다시 로드밸런서 생성 화면으로 이동

대상 그룹 선택 항목을 클릭하면 아직 대상 그룹이 보이지 않음
오른쪽 새로고침 버튼을 클릭한 후 다시 항목을 클릭하면 만들어진 exercise-target-group 이 보임!

이제 검토 부분을 확인하고 맞다면 '로드밸런서 생성' 버튼 클릭

화면 위의 생성 성공메시지 확인

이제 생성한 로드 밸런서의 대상 그룹에 앞에서 만든 Auto Scaling 그룹인 EXERCISE-GROUP 에 등록

---

EC2 대시보드 -> Auto Scaling -> Auto Scaling 그룹 클릭 -> □ EXERCISE-GROUP 선택

세부정보 탭에서 아래쪽으로 스크롤바를 이동하면 '로드 밸런싱' 항목이 나옴 -> '편집' 버튼 클릭

□ '애플리케이션, 네트워크 또는 게이트웨이 로드 밸런서 대상 그룹' 체크 -> 대상 그룹 선택 : exercise-target-group|HTTP 선택 -> 아래쪽의 '업데이트' 버튼 클릭

---

< 설정 확인 >
로드밸런싱 -> 대상 그룹 -> □ exercise-target-group 체크 -> 아래쪽의 '대상'탭으로 이동하면 등록된 대상에 exercise-group 이 추가되어 있음.
※ 만약 보이지 않는다면 '등록된 대상 새로 고침' 버튼 클릭

< 동작 확인 >
로드밸런싱 -> 로드배런서 -> exercise-lb의 DNS name을 복사
ex) exercise-lb-1882178768.ap-northeast-2.elb.amazonaws.com

복사된 내용을 웹 브라우저의 주소창에 넣음
















